<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>nginx | Chuune Wiki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="//cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-shim.min.js"></script>
  <script src="//apps.bdimg.com/libs/html5shiv/3.7/html5shiv.min.js"></script>
  <link rel="shortcut icon" type="image/png" href="favicon.png"/>
  <link rel="stylesheet" href="/css/index.css">
</head>

  <body>
  <header class="header-page">
    <div class="header-content">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <h1 class="header-logo">
        <a class="no-style header-link" href="
        
          /zh-cn
        
        ">Chuune Wiki</a>
      </h1>
      <div class="menu">
        <a class="no-style header-link" href="/zh-cn/archives">索引</a>
        <a class="no-style header-link" target="_blank" href="https://github.com/goumang2010/hexo-wiki/edit/master/source/_posts/zh-cn/nginx.md">编辑</a>
        <a class="no-style header-link" href="/readme">README</a>
        <a class="no-style header-link" target="_blank" href="https://github.com/goumang2010/hexo-wiki">GitHub</a>
      </div>
      <div id="header-search-div" class="header-search-div">
        <input id="header-search-input" class="header-search-input" type="text" placeholder="搜索"/>
        <div id="header-search-box" class="header-search-box"><ul id="header-search-list"></ul></div>
      </div>
      <div class="header-lang-select-wrap header-link menu">
        <label>
        
          简体中文
        
        </label>
        <select id="header-lang-select" class="header-lang-select">
        
          
            <option
              value=""
              selected
            >
              简体中文
            </option>
          
            <option
              value=""
              
            >
              English
            </option>
          
        
        </select>
      </div>
    </div>
 <nav id="mobile-nav">
    <a class="no-style header-link" href="
    
      /zh-cn
    
    ">首页</a>
	<a href="/zh-cn/archives">索引</a>
	<a target="_blank" href="https://github.com/goumang2010/hexo-wiki/edit/master/source/_posts/zh-cn/nginx.md">编辑</a>
	<a href="/readme">README</a>
	<a target="_blank" href="https://github.com/goumang2010/hexo-wiki">GitHub</a>
</nav>
</header>

  <section class="container">
  <h2>nginx</h2>
  nginx
  <article class="markdown-body article">
  <div class="toc"><ul><li class="level-1"><a href="#1."><span class="tocnumber">1.</span>&nbsp<span class="toctext">安装配置</span></a><ul><li class="level-2"><a href="#1.1."><span class="tocnumber">1.1.</span>&nbsp<span class="toctext">nginx配置</span></a></li><li class="level-2"><a href="#1.2."><span class="tocnumber">1.2.</span>&nbsp<span class="toctext">php.ini</span></a></li><li class="level-2"><a href="#1.3."><span class="tocnumber">1.3.</span>&nbsp<span class="toctext">php-fpm</span></a></li></ul></li><li class="level-1"><a href="#2."><span class="tocnumber">2.</span>&nbsp<span class="toctext">重启</span></a></li><li class="level-1"><a href="#3."><span class="tocnumber">3.</span>&nbsp<span class="toctext">Mediawiki</span></a></li><li class="level-1"><a href="#4."><span class="tocnumber">4.</span>&nbsp<span class="toctext">参考</span></a></li></ul></div><h1 id="1."><a href="#1." class="headerlink" title="安装配置"></a>1. 安装配置</h1><h2 id="1.1."><a href="#1.1." class="headerlink" title="nginx配置"></a>1.1. nginx配置</h2><ul>
<li>http编辑文件：<pre><code class="hljs "><span class="hljs-keyword">vim</span> /etc/nginx/nginx.<span class="hljs-keyword">conf</span></code></pre></li>
<li>监听配置文件：<pre><code class="hljs ">vim <span class="hljs-regexp">/etc/</span>nginx<span class="hljs-regexp">/sites-available/</span><span class="hljs-keyword">default</span></code></pre></li>
<li>重写：<pre><code class="hljs ">rewrite ^/(.*)  [<span class="hljs-string">http://node.chuune.top</span>](<span class="hljs-link">http://node.chuune.top</span>):3000$uri last;</code></pre>将任意字符不区分大小写重写为：<a href="http://node.chuune.top" target="_blank" rel="external">http://node.chuune.top</a>:3000加上相对路径($uri),参数会自动添加</li>
<li><p>反向代理：</p>
<ul>
<li>将所有包转发给<a href="http://localhost:3000" target="_blank" rel="external">http://localhost:3000</a></li>
</ul>
<p><code>proxy_pass http://localhost:3000;</code></p>
<ul>
<li>将原始地址(及经过的其他代理)写入header的X-Forwarded-For中，以此在后端可以读取该参数获得前端的实际IP</li>
</ul>
<p><code>proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</code></p>
</li>
</ul>
<h2 id="1.2."><a href="#1.2." class="headerlink" title="php.ini"></a>1.2. php.ini</h2><p>修改一下文件：</p>
<p>/etc/php5/cgi/php.ini </p>
<p>/etc/php5/cli/php.ini </p>
<p>/etc/php5/fpm/php.ini </p>
<p>去掉cgi.fix-pathinfo=1 的注释</p>
<h2 id="1.3."><a href="#1.3." class="headerlink" title="php-fpm"></a>1.3. php-fpm</h2><ul>
<li>php-fpm配置文件<pre><code class="hljs ">vim <span class="hljs-regexp">/etc/</span>php5<span class="hljs-regexp">/fpm/</span>php-fpm.conf</code></pre>对于小内存：<pre><code class="hljs "><span class="hljs-attr">pm=dynamic</span>
pm.<span class="hljs-attr">max_children=20</span>
pm.<span class="hljs-attr">start_servers=5</span>
pm.<span class="hljs-attr">min_spare_servers=5</span>
pm.<span class="hljs-attr">max_spare_servers=20</span>
'进程执行xxx后重启释放内存避免内存泄漏
pm.<span class="hljs-attr">max_requests</span> = <span class="hljs-number">4096</span>
'进程超时时间
<span class="hljs-attr">request_terminate_timeout</span> = <span class="hljs-number">100</span></code></pre></li>
</ul>
<h1 id="2."><a href="#2." class="headerlink" title="重启"></a>2. 重启</h1><p>重启php5-fpm：</p>
<pre><code class="hljs "><span class="hljs-regexp">/etc/i</span>nit.d<span class="hljs-regexp">/php5-fpm restart</span></code></pre><p>重启nginx：</p>
<pre><code class="hljs "> <span class="hljs-regexp">/etc/i</span>nit.d<span class="hljs-regexp">/nginx restart</span></code></pre><p>查看状态： </p>
<pre><code class="hljs "><span class="hljs-attribute">nginx -t</span></code></pre><h1 id="3."><a href="#3." class="headerlink" title="Mediawiki"></a>3. Mediawiki</h1><pre><code class="hljs ">server {
        listen <span class="hljs-number">80</span>;
        server_name wiki.chuune.top;
        root /var/www/html/wiki;
        index  index.php;
    client_max_body_size <span class="hljs-number">5m</span>;
    client_body_timeout <span class="hljs-number">60</span>;

    <span class="hljs-keyword">location</span> <span class="hljs-title">/ {
        try_files</span> $uri $uri/ @rewrite;
    }

    <span class="hljs-keyword">location</span> <span class="hljs-title">@rewrite</span> {
        rewrite ^/(.*)$ /index.php?<span class="hljs-attr">title=</span>$<span class="hljs-number">1</span>&amp;$args;
    }

    <span class="hljs-keyword">location</span> <span class="hljs-title">^~ /maintenance</span>/ {
        return <span class="hljs-number">403</span>;
    }

    <span class="hljs-keyword">location</span> <span class="hljs-title">~ \.php</span>$ {
        include snippets/fastcgi-php.conf;
        <span class="hljs-comment">#</span>
        <span class="hljs-comment">#       # With php5-cgi alone:</span>
        <span class="hljs-comment">#       fastcgi_pass 127.0.0.1:9000;</span>
        <span class="hljs-comment">#       # With php5-fpm:</span>
        fastcgi_pass unix:/var/run/php5-fpm.sock;

    }

    <span class="hljs-keyword">location</span> <span class="hljs-title">~* \.(js</span>|css|png|jpg|jpeg|gif|ico)$ {
        try_files $uri /index.php;
        expires max;
        log_not_found off;
    }

    <span class="hljs-keyword">location</span> <span class="hljs-title">= /_</span>.gif {
        expires max;
        empty_gif;
    }

    <span class="hljs-keyword">location</span> <span class="hljs-title">^~ /cache</span>/ {
        <span class="hljs-keyword">deny</span> all;
    }

    <span class="hljs-keyword">location</span> <span class="hljs-title">/dumps</span> {
        root /var/www/mediawiki/local;
        autoindex on;
    }

}</code></pre><p>设置参考：<br><a href="https://www.nginx.com/resources/wiki/start/topics/recipes/mediawiki/?highlight=mediawiki" target="_blank" rel="external">https://www.nginx.com/resources/wiki/start/topics/recipes/mediawiki/?highlight=mediawiki</a>#</p>
<p><a href="https://www.mediawiki.org/wiki/Manual" target="_blank" rel="external">https://www.mediawiki.org/wiki/Manual</a>:Short_URL/wiki/Page<em>title</em>–_nginx_rewrite–root_access</p>
<h1 id="4."><a href="#4." class="headerlink" title="参考"></a>4. 参考</h1><p><a href="http://blog.csdn.net/rainysia/article/details/12972975" target="_blank" rel="external">http://blog.csdn.net/rainysia/article/details/12972975</a></p>
 
</section>

  <section class="footer">
  <div class="container">
    <span class="footer-item">Text is available under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
    <span class="footer-item">Created by <a href="null">ZN</a></span>
    <span class="footer-item">Powered by <a href="https://hexo.io">Hexo</a></span>
    <span class="footer-item">Themed by <a href="https://github.com/xcatliu/hexo-theme-wiki-i18n">wiki-i18n</a></span>
    <span class="footer-item">Hosted by <a href="https://pages.github.com/">GitHub Pages</a></span>
  </div>
</section>

  <script>
  window.HEXO_DATA = {
    config: {"title":"Chuune Wiki","subtitle":"Write something","description":null,"author":"ZN","language":["zh-cn","en","default"],"timezone":null,"url":"http://yoursite.com","root":"/","permalink":":category/:title.html","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":lang/:title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":false,"auto_detect":true,"line_number":false,"tab_replace":null},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":1000,"pagination_dir":"page","theme":"wiki-i18n","deploy":{"type":"git","repo":"git@github.com:goumang2010/hexo-wiki.git","branch":"gh-pages","message":null},"ignore":[],"author_link":null,"github":"https://github.com/goumang2010/hexo-wiki","index_generator":{"per_page":10,"order_by":"-date"},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true},"jsonContent":{"meta":false,"pages":true,"posts":{"title":true,"date":true,"path":true,"text":true,"raw":false,"content":false,"slug":false,"updated":false,"comments":false,"link":false,"permalink":false,"excerpt":true,"categories":false,"tags":false}},"archive_generator":{"per_page":1000,"yearly":true,"monthly":true,"daily":false},"category_generator":{"per_page":1000},"tag_generator":{"per_page":1000},"server":{"port":4000,"log":false,"ip":"0.0.0.0","compress":false,"header":true}},
  };
</script>

  <script src="/js/dist/custom.min.js?v=82187259147"> </script>


  </body>
</html>
